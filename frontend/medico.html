<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Oncoatlas - Panel Médico</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }

    header {
      background-color: #1f2933;
      color: white;
      padding: 16px 24px;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
    }

    main {
      padding: 16px 24px;
      display: flex;
      gap: 24px;
    }

    .panel {
      background-color: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
      flex: 1;
      min-width: 0;
    }

    h2 {
      margin-top: 0;
      font-size: 18px;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }

    th, td {
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      font-size: 14px;
      text-align: left;
    }

    th {
      background-color: #f9fafb;
    }

    tr.selectable:hover {
      background-color: #f0f9ff;
      cursor: pointer;
    }

    tr.selected {
      background-color: #dbeafe !important;
    }

    .small {
      font-size: 12px;
      color: #6b7280;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      color: white;
      background-color: #2563eb;
    }

    .danger {
      background-color: #dc2626;
    }

    .btn {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 4px;
      background-color: #2563eb;
      color: white;
      border: none;
      font-size: 14px;
      cursor: pointer;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .input-row {
      margin-bottom: 8px;
    }

    input[type="file"] {
      display: block;
      margin-top: 4px;
      font-size: 13px;
    }

    .status {
      margin-top: 8px;
      font-size: 13px;
    }

    .status.error {
      color: #b91c1c;
    }

    .status.ok {
      color: #15803d;
    }

    .variants-list {
      margin-top: 4px;
      padding-left: 16px;
      font-size: 13px;
    }

    .variants-list li {
      margin-bottom: 4px;
    }

    a {
      color: #2563eb;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <header>
    <h1>Oncoatlas - Panel Médico (Local)</h1>
  </header>

  <main>
    <!-- Panel de pacientes -->
    <section class="panel">
      <h2>Pacientes</h2>
      <p class="small">
        Haz clic en un paciente para ver sus análisis y cargar nuevos archivos FASTA.
      </p>
      <table id="patients-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre completo</th>
            <th>Documento</th>
            <th>Edad</th>
            <th>Género</th>
          </tr>
        </thead>
        <tbody id="patients-tbody">
          <!-- Se llena con JavaScript -->
        </tbody>
      </table>
    </section>

    <!-- Panel de análisis -->
    <section class="panel">
      <h2>Análisis germinal BRCA1/BRCA2</h2>
      <div id="selected-patient-info" class="small">
        Ningún paciente seleccionado.
      </div>

      <h3 style="font-size:16px; margin-top:12px;">Nuevo análisis</h3>
      <div class="input-row">
        <label>Archivo FASTA BRCA1:</label>
        <input type="file" id="brca1-input" accept=".fasta,.fa,.txt" />
      </div>
      <div class="input-row">
        <label>Archivo FASTA BRCA2:</label>
        <input type="file" id="brca2-input" accept=".fasta,.fa,.txt" />
      </div>
      <button id="run-analysis-btn" class="btn" disabled>Subir y analizar</button>
      <div id="analysis-status" class="status"></div>

      <h3 style="font-size:16px; margin-top:16px;">Historial de análisis del paciente</h3>
      <div id="analyses-container" class="small">
        Selecciona un paciente para ver sus análisis.
      </div>
    </section>
  </main>

  <script>
    const API_BASE = "http://127.0.0.1:8000";

    let patients = [];
    let selectedPatientId = null;

    const patientsTbody = document.getElementById("patients-tbody");
    const selectedPatientInfo = document.getElementById("selected-patient-info");
    const analysesContainer = document.getElementById("analyses-container");
    const runAnalysisBtn = document.getElementById("run-analysis-btn");
    const statusDiv = document.getElementById("analysis-status");
    const brca1Input = document.getElementById("brca1-input");
    const brca2Input = document.getElementById("brca2-input");

    // Cargar pacientes al iniciar
    window.addEventListener("DOMContentLoaded", () => {
      loadPatients();
    });

    async function loadPatients() {
      try {
        const res = await fetch(`${API_BASE}/patients/`);
        if (!res.ok) {
          throw new Error("Error al cargar pacientes");
        }
        patients = await res.json();
        renderPatients();
      } catch (err) {
        console.error(err);
        patientsTbody.innerHTML = `<tr><td colspan="5" class="small" style="color:#b91c1c;">No se pudieron cargar los pacientes.</td></tr>`;
      }
    }

    function renderPatients() {
      patientsTbody.innerHTML = "";

      if (patients.length === 0) {
        patientsTbody.innerHTML = `<tr><td colspan="5" class="small">No hay pacientes registrados.</td></tr>`;
        return;
      }

      patients.forEach((p) => {
        const tr = document.createElement("tr");
        tr.classList.add("selectable");
        if (p.id === selectedPatientId) {
          tr.classList.add("selected");
        }

        tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.full_name}</td>
          <td>${p.document_number}</td>
          <td>${p.age ?? "-"}</td>
          <td>${p.gender ?? "-"}</td>
        `;

        tr.addEventListener("click", () => {
          selectPatient(p.id);
        });

        patientsTbody.appendChild(tr);
      });
    }

    function selectPatient(id) {
      selectedPatientId = id;
      const patient = patients.find((p) => p.id === id);

      // Actualizar info
      if (patient) {
        selectedPatientInfo.textContent =
          `Paciente seleccionado: [${patient.id}] ${patient.full_name} (doc: ${patient.document_number})`;
      } else {
        selectedPatientInfo.textContent = "Paciente seleccionado: " + id;
      }

      // Habilitar botón si hay paciente y archivos
      updateRunButtonState();

      // Marcar fila seleccionada
      Array.from(patientsTbody.children).forEach((tr) => tr.classList.remove("selected"));
      const row = Array.from(patientsTbody.children).find(
        (tr) => parseInt(tr.children[0].textContent, 10) === id
      );
      if (row) {
        row.classList.add("selected");
      }

      // Cargar análisis del paciente
      loadAnalysesForPatient(id);
    }

    function updateRunButtonState() {
      const hasPatient = selectedPatientId !== null;
      const hasFiles =
        brca1Input.files && brca1Input.files.length > 0 &&
        brca2Input.files && brca2Input.files.length > 0;
      runAnalysisBtn.disabled = !(hasPatient && hasFiles);
    }

    brca1Input.addEventListener("change", updateRunButtonState);
    brca2Input.addEventListener("change", updateRunButtonState);

    async function loadAnalysesForPatient(id) {
      analysesContainer.textContent = "Cargando análisis...";
      try {
        const res = await fetch(`${API_BASE}/patients/${id}/analyses`);
        if (!res.ok) {
          throw new Error("Error al cargar análisis");
        }
        const analyses = await res.json();
        renderAnalyses(analyses);
      } catch (err) {
        console.error(err);
        analysesContainer.innerHTML =
          `<span class="status error">No se pudieron cargar los análisis.</span>`;
      }
    }

    function renderAnalyses(analyses) {
      if (!analyses || analyses.length === 0) {
        analysesContainer.innerHTML =
          `<span class="small">Este paciente no tiene análisis registrados.</span>`;
        return;
      }

      const parts = analyses.map((a) => {
        const dateText = a.created_at ? a.created_at : "";
        const variants = Array.isArray(a.variants) ? a.variants : [];
        const variantsHtml =
          variants.length === 0
            ? "<li>Sin variantes patogénicas conocidas.</li>"
            : variants
                .map((v) => {
                  const link = v.clinvar_url
                    ? ` - <a href="${v.clinvar_url}" target="_blank" rel="noreferrer">ClinVar</a>`
                    : "";
                  return `<li><span class="badge danger">${v.gene}</span>
                    ${v.cdna_change} / ${v.protein_change}
                    (${v.significance})${link}</li>`;
                })
                .join("");

        return `
          <div style="margin-bottom:12px; padding-bottom:8px; border-bottom:1px solid #e5e7eb;">
            <div><strong>Análisis #${a.analysis_id}</strong> <span class="small">${dateText}</span></div>
            <div class="small">${a.summary}</div>
            <ul class="variants-list">
              ${variantsHtml}
            </ul>
          </div>
        `;
      });

      analysesContainer.innerHTML = parts.join("");
    }

    runAnalysisBtn.addEventListener("click", async () => {
      if (!selectedPatientId) return;

      if (
        !brca1Input.files ||
        brca1Input.files.length === 0 ||
        !brca2Input.files ||
        brca2Input.files.length === 0
      ) {
        statusDiv.textContent = "Debes seleccionar ambos archivos FASTA.";
        statusDiv.className = "status error";
        return;
      }

      const formData = new FormData();
      formData.append("brca1_file", brca1Input.files[0]);
      formData.append("brca2_file", brca2Input.files[0]);

      statusDiv.textContent = "Enviando archivos y ejecutando análisis...";
      statusDiv.className = "status";

      try {
        const res = await fetch(
          `${API_BASE}/analysis/run_for_patient?patient_id=${selectedPatientId}`,
          {
            method: "POST",
            body: formData,
          }
        );

        if (!res.ok) {
          const text = await res.text();
          throw new Error(`Error ${res.status}: ${text}`);
        }

        const data = await res.json();
        statusDiv.textContent = data.summary || "Análisis completado correctamente.";
        statusDiv.className = "status ok";

        // Recargar el historial de análisis
        loadAnalysesForPatient(selectedPatientId);
      } catch (err) {
        console.error(err);
        statusDiv.textContent = "Error al ejecutar el análisis.";
        statusDiv.className = "status error";
      }
    });
  </script>
</body>
</html>
