<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Oncoatlas · Panel Médico</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
        /* Ajustes pequeños específicos de esta vista
           (el resto del estilo viene de styles.css) */

        .layout {
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
        }

        .panel {
            background: #ffffff;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        }

        .panel h2 {
            margin-top: 0;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .panel-header small {
            color: #666;
        }

        .two-columns {
            display: grid;
            grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.3fr);
            gap: 1.5rem;
        }

        .field-group {
            margin-bottom: 0.75rem;
        }

        .field-group label {
            display: block;
            font-size: 0.85rem;
            margin-bottom: 0.2rem;
            color: #333;
        }

        .field-row {
            display: flex;
            gap: 0.5rem;
        }

        .field-row > * {
            flex: 1;
        }

        .patients-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .patients-table th,
        .patients-table td {
            border-bottom: 1px solid #eee;
            padding: 0.35rem 0.4rem;
            text-align: left;
        }

        .patients-table th {
            background: #fafafa;
            font-weight: 600;
        }

        .alert {
            padding: 0.6rem 0.9rem;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
        }

        .alert-success {
            background: #e6f9ec;
            color: #136c31;
            border: 1px solid #b9ebc9;
        }

        .alert-error {
            background: #ffecec;
            color: #9b1c1c;
            border: 1px solid #f5b5b5;
        }

        .badge {
            display: inline-block;
            padding: 0.2rem 0.4rem;
            border-radius: 999px;
            background: #eef2ff;
            color: #3730a3;
            font-size: 0.75rem;
        }

        .analysis-summary {
            font-size: 0.9rem;
            margin-bottom: 0.6rem;
        }

        .analysis-meta {
            font-size: 0.8rem;
            color: #555;
            margin-bottom: 0.4rem;
        }

        .variants-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            margin-top: 0.4rem;
        }

        .variants-table th,
        .variants-table td {
            border-bottom: 1px solid #eee;
            padding: 0.25rem 0.3rem;
            text-align: left;
        }

        .variants-table th {
            background: #fafafa;
        }

        .results-card {
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            padding: 0.75rem 0.9rem;
            background: #fafafa;
            max-height: 380px;
            overflow: auto;
        }

        .raw-json-toggle {
            margin-top: 0.5rem;
            font-size: 0.78rem;
            color: #555;
            cursor: pointer;
            text-decoration: underline;
        }

        #analysisRawJson {
            width: 100%;
            height: 180px;
            margin-top: 0.4rem;
            font-family: "Fira Code", monospace;
            font-size: 0.75rem;
            display: none;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 999px;
            padding: 0.35rem 0.9rem;
            font-size: 0.82rem;
            border: none;
            cursor: pointer;
        }

        .btn-primary {
            background: #2563eb;
            color: #fff;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #111827;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid #d1d5db;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 1rem;
        }

        .top-bar small {
            color: #555;
        }

        .flow-text {
            font-size: 0.78rem;
            color: #4b5563;
        }
    </style>
</head>
<body>
<header class="top-bar">
    <div>
        <h1>Oncoatlas · Panel Médico</h1>
        <p class="flow-text">
            Flujo: Paciente → FASTA BRCA1/BRCA2 → Análisis germinal → Informe
        </p>
    </div>
    <div style="text-align: right;">
        <div class="flow-text">
            Backend:
            <span id="backendUrlDisplay">http://127.0.0.1:8000</span>
            · <span class="badge">Uso académico</span>
        </div>
        <div class="flow-text" id="activeDoctorDisplay">
            Médico activo: Dr. Demo (ID 5)
        </div>
    </div>
</header>

<main class="layout two-columns">
    <!-- PANEL IZQUIERDO: PACIENTES -->
    <section class="panel">
        <div class="panel-header">
            <h2>Gestión de pacientes</h2>
            <button id="reloadPatientsBtn" class="btn btn-outline" type="button">
                Recargar lista
            </button>
        </div>

        <p class="flow-text">
            Crea pacientes y selecciónalos para correr análisis germinales.
        </p>

        <form id="patientForm">
            <div class="field-group">
                <label for="fullNameInput">Nombre completo</label>
                <input id="fullNameInput" type="text" placeholder="Ej: Paciente Demo" required />
            </div>

            <div class="field-group">
                <label for="documentIdInput">Documento de identidad</label>
                <input id="documentIdInput" type="text" placeholder="Ej: 123456789" required />
            </div>

            <div class="field-group field-row">
                <div>
                    <label for="sexSelect">Sexo biológico</label>
                    <select id="sexSelect">
                        <option value="">Sin especificar</option>
                        <option value="F">Femenino</option>
                        <option value="M">Masculino</option>
                        <option value="O">Otro</option>
                    </select>
                </div>
                <div>
                    <label for="dobInput">Fecha de nacimiento</label>
                    <input id="dobInput" type="date" />
                </div>
            </div>

            <div class="field-row" style="margin-top: 0.6rem;">
                <button type="submit" class="btn btn-primary">Crear paciente</button>
            </div>
        </form>

        <hr style="margin: 1rem 0;" />

        <div class="field-group">
            <label for="patientSelect">Paciente seleccionado para análisis</label>
            <select id="patientSelect">
                <option value="">(Selecciona un paciente...)</option>
            </select>
        </div>

        <div class="field-group">
            <label>Pacientes registrados (recientes primero):</label>
            <div style="max-height: 200px; overflow: auto; border-radius: 8px; border: 1px solid #e5e7eb;">
                <table class="patients-table" id="patientsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Documento</th>
                            <th>Sexo</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- filas dinámicas -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- PANEL DERECHO: ANÁLISIS GERMINAL -->
    <section class="panel">
        <div id="globalAlert" class="alert" style="display:none;"></div>

        <div class="panel-header">
            <h2>Análisis germinal BRCA1/BRCA2</h2>
            <small id="selectedPatientSummary">Paciente seleccionado: ninguno</small>
        </div>

        <p class="flow-text">
            Sube los archivos FASTA de BRCA1 y BRCA2 para el paciente seleccionado. El análisis compara
            contra las secuencias de referencia internas y genera un resumen clínico y un informe en PDF.
        </p>

        <div class="field-group">
            <label for="brca1FileInput">Archivo FASTA · BRCA1</label>
            <input id="brca1FileInput" type="file" accept=".fasta,.fa,.txt" />
        </div>

        <div class="field-group">
            <label for="brca2FileInput">Archivo FASTA · BRCA2</label>
            <input id="brca2FileInput" type="file" accept=".fasta,.fa,.txt" />
        </div>

        <div class="field-row" style="margin-top: 0.7rem;">
            <button id="runAnalysisBtn" class="btn btn-primary" type="button">
                Ejecutar análisis germinal
            </button>
            <button id="clearResultsBtn" class="btn btn-secondary" type="button">
                Limpiar resultados
            </button>
            <button id="pdfBtn" class="btn btn-outline" type="button" disabled>
                Generar informe PDF
            </button>
        </div>

        <hr style="margin: 1rem 0;" />

        <div class="field-group">
            <label>Resultados de análisis:</label>
            <div id="analysisResults" class="results-card">
                <span class="flow-text">Sin resultados de análisis.</span>
            </div>

            <div class="raw-json-toggle" id="toggleRawJson">
                Mostrar JSON bruto de la respuesta
            </div>
            <textarea id="analysisRawJson" readonly></textarea>
        </div>
    </section>
</main>

<script>
    // ================== CONFIGURACIÓN BÁSICA ==================
    const BACKEND_URL = "http://127.0.0.1:8000";
    const ACTIVE_DOCTOR_ID = 5; // por ahora fijo; se puede parametrizar más adelante

    document.getElementById("backendUrlDisplay").textContent = BACKEND_URL;

    // ================== UTILIDADES ==================

    function showAlert(message, type = "success") {
        const box = document.getElementById("globalAlert");
        box.textContent = message;
        box.className = "alert " + (type === "success" ? "alert-success" : "alert-error");
        box.style.display = "block";
    }

    function clearAlert() {
        const box = document.getElementById("globalAlert");
        box.style.display = "none";
        box.textContent = "";
    }

    function formatDateTime(isoString) {
        if (!isoString) return "N/D";
        const d = new Date(isoString);
        if (isNaN(d.getTime())) return isoString;
        const pad = (n) => String(n).padStart(2, "0");
        return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function escapeHtml(str) {
        if (str == null) return "";
        return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // ================== PACIENTES ==================

    async function loadPatients() {
        try {
            const res = await fetch(`${BACKEND_URL}/doctors/${ACTIVE_DOCTOR_ID}/patients`);
            if (!res.ok) throw new Error("No se pudo cargar la lista de pacientes");
            const patients = await res.json();
            renderPatients(patients);
        } catch (err) {
            console.error(err);
            showAlert(err.message || "Error al cargar pacientes", "error");
        }
    }

    function renderPatients(patients) {
        const tbody = document.querySelector("#patientsTable tbody");
        const select = document.getElementById("patientSelect");
        tbody.innerHTML = "";
        select.innerHTML = '<option value="">(Selecciona un paciente...)</option>';

        // ordenar: id descendente (recientes primero)
        patients.sort((a, b) => b.id - a.id);

        for (const p of patients) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${p.id}</td>
                <td>${escapeHtml(p.full_name || "")}</td>
                <td>${escapeHtml(p.document_id || "")}</td>
                <td>${escapeHtml(p.sex || "")}</td>
            `;
            tbody.appendChild(tr);

            const opt = document.createElement("option");
            opt.value = p.id;
            opt.textContent = `ID ${p.id} · ${p.full_name || "Sin nombre"}`;
            opt.dataset.documentId = p.document_id || "";
            select.appendChild(opt);
        }

        updateSelectedPatientSummary();
    }

    function updateSelectedPatientSummary() {
        const select = document.getElementById("patientSelect");
        const summary = document.getElementById("selectedPatientSummary");
        const opt = select.selectedOptions[0];
        if (!opt) {
            summary.textContent = "Paciente seleccionado: ninguno";
        } else {
            summary.textContent = `Paciente seleccionado: ${opt.textContent}`;
        }
    }

    async function handleCreatePatient(event) {
        event.preventDefault();
        clearAlert();

        const full_name = document.getElementById("fullNameInput").value.trim();
        const document_id = document.getElementById("documentIdInput").value.trim();
        const sex = document.getElementById("sexSelect").value || null;
        const date_of_birth = document.getElementById("dobInput").value || null;

        if (!full_name || !document_id) {
            showAlert("Nombre completo y documento son obligatorios.", "error");
            return;
        }

        const payload = {
            full_name,
            document_id,
            sex,
            date_of_birth
        };

        try {
            const res = await fetch(`${BACKEND_URL}/doctors/${ACTIVE_DOCTOR_ID}/patients`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            if (!res.ok) {
                const errData = await res.json().catch(() => ({}));
                throw new Error(errData.detail || "No se pudo crear el paciente");
            }
            const patient = await res.json();
            showAlert(`Paciente creado (ID ${patient.id}).`, "success");
            // limpiar formulario
            document.getElementById("patientForm").reset();
            await loadPatients();
            document.getElementById("patientSelect").value = String(patient.id);
            updateSelectedPatientSummary();
        } catch (err) {
            console.error(err);
            showAlert(err.message || "Error al crear paciente", "error");
        }
    }

    // ================== ANÁLISIS GERMINAL ==================

    async function handleRunAnalysis() {
        clearAlert();

        const patientSelect = document.getElementById("patientSelect");
        const patientId = patientSelect.value;

        if (!patientId) {
            showAlert("Selecciona un paciente antes de ejecutar el análisis.", "error");
            return;
        }

        const brca1File = document.getElementById("brca1FileInput").files[0];
        const brca2File = document.getElementById("brca2FileInput").files[0];

        if (!brca1File || !brca2File) {
            showAlert("Debes subir los archivos FASTA de BRCA1 y BRCA2.", "error");
            return;
        }

        const btn = document.getElementById("runAnalysisBtn");
        btn.disabled = true;
        btn.textContent = "Ejecutando...";

        const formData = new FormData();
        formData.append("brca1_fasta", brca1File);
        formData.append("brca2_fasta", brca2File);

        try {
            const res = await fetch(`${BACKEND_URL}/patients/${patientId}/analyses/run-germline`, {
                method: "POST",
                body: formData
            });

            if (!res.ok) {
                const errData = await res.json().catch(() => ({}));
                const msg =
                    (errData.detail && (Array.isArray(errData.detail)
                        ? errData.detail.map(d => d.msg || d).join("; ")
                        : errData.detail)) ||
                    "Error al ejecutar el análisis germinal.";
                throw new Error(msg);
            }

            const analysis = await res.json();
            renderAnalysisResult(analysis);
            showAlert("Análisis germinal ejecutado correctamente.", "success");
        } catch (err) {
            console.error(err);
            showAlert(err.message || "Error al ejecutar el análisis germinal.", "error");
        } finally {
            btn.disabled = false;
            btn.textContent = "Ejecutar análisis germinal";
        }
    }

    function renderAnalysisResult(analysis) {
        const container = document.getElementById("analysisResults");
        const rawJson = document.getElementById("analysisRawJson");
        const pdfBtn = document.getElementById("pdfBtn");

        rawJson.value = JSON.stringify(analysis, null, 2);

        const createdAt = formatDateTime(analysis.created_at);
        const summary = analysis.summary || "Sin resumen disponible.";
        const details = analysis.details || {};
        const brca1 = details.brca1 || {};
        const brca2 = details.brca2 || {};

        const snvCount1 = brca1.snv_count ?? (brca1.snvs ? brca1.snvs.length : 0);
        const snvCount2 = brca2.snv_count ?? (brca2.snvs ? brca2.snvs.length : 0);

        const brca1Snvs = (brca1.snvs || []).slice(0, 10);
        const brca2Snvs = (brca2.snvs || []).slice(0, 10);

        container.innerHTML = `
            <div class="analysis-meta">
                <div><strong>ID de análisis:</strong> ${analysis.id}</div>
                <div><strong>Estado:</strong> ${escapeHtml(analysis.status || "desconocido")}</div>
                <div><strong>Fecha del análisis:</strong> ${createdAt}</div>
            </div>

            <div class="analysis-summary">
                <strong>Resumen:</strong> ${escapeHtml(summary)}
            </div>

            <div class="analysis-summary">
                <strong>Conteo global de variantes (SNV):</strong><br/>
                · BRCA1: <strong>${snvCount1}</strong> SNV<br/>
                · BRCA2: <strong>${snvCount2}</strong> SNV
            </div>

            <div style="margin-top:0.6rem;">
                <strong>Variantes destacadas (máx. 10 por gen):</strong>
            </div>

            <div style="margin-top:0.4rem;">
                <strong>BRCA1</strong>
                ${renderVariantsTable(brca1Snvs)}
            </div>

            <div style="margin-top:0.6rem;">
                <strong>BRCA2</strong>
                ${renderVariantsTable(brca2Snvs)}
            </div>

            <div class="flow-text" style="margin-top:0.6rem;">
                Nota: solo se muestran algunas variantes para vista rápida. El informe PDF incluye un resumen estructurado para uso clínico.
            </div>
        `;

        // activar botón PDF
        pdfBtn.disabled = false;
        pdfBtn.onclick = () => {
            const url = `${BACKEND_URL}/patients/${analysis.patient_id}/analyses/${analysis.id}/report-pdf`;
            window.open(url, "_blank");
        };
    }

    function renderVariantsTable(snvs) {
        if (!snvs || snvs.length === 0) {
            return `<div class="flow-text">Sin variantes listadas.</div>`;
        }

        const rows = snvs.map(snv => {
            const pos = snv.position ?? "";
            const ref = snv.ref ?? "";
            const alt = snv.alt ?? "";
            const type = snv.type ?? "";
            const gene = snv.gene ?? "";
            return `
                <tr>
                    <td>${escapeHtml(String(pos))}</td>
                    <td>${escapeHtml(gene)}</td>
                    <td>${escapeHtml(ref)}→${escapeHtml(alt)}</td>
                    <td>${escapeHtml(type)}</td>
                </tr>
            `;
        }).join("");

        return `
            <div style="max-height: 160px; overflow:auto;">
                <table class="variants-table">
                    <thead>
                        <tr>
                            <th>Posición</th>
                            <th>Gen</th>
                            <th>Ref→Alt</th>
                            <th>Tipo</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            </div>
        `;
    }

    function handleClearResults() {
        document.getElementById("analysisResults").innerHTML =
            '<span class="flow-text">Sin resultados de análisis.</span>';
        document.getElementById("analysisRawJson").value = "";
        document.getElementById("analysisRawJson").style.display = "none";
        document.getElementById("toggleRawJson").textContent = "Mostrar JSON bruto de la respuesta";
        document.getElementById("pdfBtn").disabled = true;
    }

    function handleToggleRawJson() {
        const textarea = document.getElementById("analysisRawJson");
        const toggle = document.getElementById("toggleRawJson");
        const visible = textarea.style.display !== "none";
        textarea.style.display = visible ? "none" : "block";
        toggle.textContent = visible
            ? "Mostrar JSON bruto de la respuesta"
            : "Ocultar JSON bruto de la respuesta";
    }

    // ================== EVENTOS Y ARRANQUE ==================

    document.getElementById("patientForm").addEventListener("submit", handleCreatePatient);
    document.getElementById("reloadPatientsBtn").addEventListener("click", loadPatients);
    document.getElementById("patientSelect").addEventListener("change", updateSelectedPatientSummary);
    document.getElementById("runAnalysisBtn").addEventListener("click", handleRunAnalysis);
    document.getElementById("clearResultsBtn").addEventListener("click", handleClearResults);
    document.getElementById("toggleRawJson").addEventListener("click", handleToggleRawJson);

    // Carga inicial
    loadPatients();
</script>
</body>
</html>

